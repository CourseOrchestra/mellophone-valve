name: "Tests"

on:
  workflow_call:

jobs:
  unit:
    name: "Unit | Py${{ matrix.python-version }} on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            python-version: '3.7'
          - os: ubuntu-22.04
            python-version: '3.8'
          - os: ubuntu-22.04
            python-version: '3.9'
          - os: ubuntu-22.04
            python-version: '3.10'
          - os: ubuntu-22.04
            python-version: '3.11'
          - os: ubuntu-22.04
            python-version: '3.12'
          - os: ubuntu-22.04
            python-version: '3.13'
          - os: ubuntu-22.04
            python-version: '3.14'
          - os: macos-latest
            python-version: '3.13'
          - os: windows-latest
            python-version: '3.13'

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            uv.lock

      - name: "Install unit test dependencies"
        run: python -m pip install --upgrade pip pytest pytest-cov httpx requests pyyaml

      - name: "Run unit tests with coverage"
        env:
          COVERAGE_FILE: coverage-unit.dat
        run: >
          pytest -q tests/test_mellophone.py tests/test_structures.py
          --cov=src/mellophone
          --cov-report=

      - name: "Upload unit coverage data"
        if: matrix.os == 'ubuntu-22.04' && matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit-data
          path: coverage-unit.dat

  integration:
    name: "Integration | Py3.13 on ubuntu-22.04"
    runs-on: ubuntu-22.04

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            uv.lock

      - name: "Install integration test dependencies"
        run: python -m pip install --upgrade pip pytest pytest-cov httpx requests pyyaml

      - name: "Cache Docker images"
        id: docker-cache
        uses: actions/cache@v4
        with:
          path: /tmp/docker-image-cache
          key: docker-images-${{ runner.os }}-${{ hashFiles('docker-compose.yml') }}

      - name: "Load cached Docker images"
        if: steps.docker-cache.outputs.cache-hit == 'true'
        shell: bash
        run: |
          [ -f /tmp/docker-image-cache/mellophone.tar ] && docker load -i /tmp/docker-image-cache/mellophone.tar || true
          [ -f /tmp/docker-image-cache/postgres.tar ] && docker load -i /tmp/docker-image-cache/postgres.tar || true

      - name: "Pull Docker images"
        if: steps.docker-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          docker pull curs/mellophone2:1.6.1
          docker pull postgres:16.3-alpine

      - name: "Save Docker images to cache"
        if: steps.docker-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p /tmp/docker-image-cache
          docker save curs/mellophone2:1.6.1 -o /tmp/docker-image-cache/mellophone.tar
          docker save postgres:16.3-alpine -o /tmp/docker-image-cache/postgres.tar

      - name: "Start DB and Mellophone"
        run: docker compose up -d db mellophone

      - name: "Wait for Mellophone"
        shell: bash
        run: |
          for i in {1..20}; do
            if curl -fsS "http://localhost:8082/mellophone/authentication.gif?sesid=ci-smoke" >/dev/null; then
              echo "Mellophone is reachable"
              exit 0
            fi
            sleep 2
          done
          docker compose logs
          exit 1

      - name: "Run integration tests with coverage"
        env:
          COVERAGE_FILE: coverage-integration.dat
        run: >
          pytest -q tests/test_integration_mellophone.py
          --cov=src/mellophone
          --cov-report=

      - name: "Upload integration coverage data"
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration-data
          path: coverage-integration.dat

      - name: "Stop services"
        if: always()
        run: docker compose down -v

  coverage-report:
    name: "Coverage Report"
    needs: [unit, integration]
    runs-on: ubuntu-22.04

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: "Download unit coverage data"
        uses: actions/download-artifact@v4
        with:
          name: coverage-unit-data
          path: coverage_data/unit

      - name: "Download integration coverage data"
        uses: actions/download-artifact@v4
        with:
          name: coverage-integration-data
          path: coverage_data/integration

      - name: "Install coverage tools"
        run: python -m pip install --upgrade pip coverage

      - name: "Combine and build coverage reports"
        run: |
          python -m coverage combine coverage_data/unit/coverage-unit.dat coverage_data/integration/coverage-integration.dat
          python -m coverage report -m
          python -m coverage xml -o coverage.xml
          python -m coverage json -o coverage.json

      - name: "Add coverage to job summary"
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const report = JSON.parse(fs.readFileSync("coverage.json", "utf8"));
            const total = report.totals.percent_covered_display;
            core.summary
              .addHeading("Coverage (unit + integration)", 2)
              .addRaw(`- Total: ${total}%`)
              .write();

      - name: "Upload coverage artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            coverage.json
