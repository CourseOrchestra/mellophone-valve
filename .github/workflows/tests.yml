name: "🧪 Tests"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  unit:
    name: "🧪 Unit | Py${{ matrix.python-version }} on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            python-version: '3.7'
          - os: ubuntu-22.04
            python-version: '3.8'
          - os: ubuntu-22.04
            python-version: '3.9'
          - os: ubuntu-22.04
            python-version: '3.10'
          - os: ubuntu-22.04
            python-version: '3.11'
          - os: ubuntu-22.04
            python-version: '3.12'
          - os: ubuntu-22.04
            python-version: '3.13'
          - os: ubuntu-22.04
            python-version: '3.14'
          - os: macos-latest
            python-version: '3.13'
          - os: windows-latest
            python-version: '3.13'

    steps:
      - name: "📥 Checkout"
        uses: actions/checkout@v4

      - name: "🐍 Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: "📦 Install unit test dependencies"
        run: python -m pip install --upgrade pip pytest httpx requests pyyaml

      - name: "🧪 Run unit tests"
        run: pytest -q tests/test_mellophone.py

  integration:
    name: "🐳 Integration | Py3.13 on ubuntu-22.04"
    runs-on: ubuntu-22.04

    steps:
      - name: "📥 Checkout"
        uses: actions/checkout@v4

      - name: "🐍 Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: "📦 Install integration test dependencies"
        run: python -m pip install --upgrade pip pytest httpx requests pyyaml

      - name: "🐳 Start DB and Mellophone"
        run: docker compose up -d db mellophone

      - name: "⏳ Wait for Mellophone"
        shell: bash
        run: |
          for i in {1..20}; do
            if curl -fsS "http://localhost:8082/mellophone/authentication.gif?sesid=ci-smoke" >/dev/null; then
              echo "Mellophone is reachable"
              exit 0
            fi
            sleep 2
          done
          docker compose logs
          exit 1

      - name: "🧪 Run integration tests"
        run: pytest -q tests/test_integration_mellophone.py

      - name: "🧹 Stop services"
        if: always()
        run: docker compose down -v
